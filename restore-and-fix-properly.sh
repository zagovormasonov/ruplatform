#!/bin/bash

echo "üîß –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ò –ò–°–ü–†–ê–í–õ–Ø–ï–ú –ü–†–ê–í–ò–õ–¨–ù–û..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
restore_original_files() {
    echo -e "${YELLOW}1. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã...${NC}"

    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º nginx –∏ PM2 —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –æ—à–∏–±–∫–∏
    echo -e "   üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
    sudo systemctl stop nginx 2>/dev/null || echo "   nginx —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    pm2 stop all 2>/dev/null || echo "   PM2 —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

    # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º frontend —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
    echo -e "   üîß –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º frontend —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º VITE_API_URL..."

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
    echo "VITE_API_URL=https://soulsynergy.ru/api" > /home/node/ruplatform/client/.env.production

    # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∫–ª–∏–µ–Ω—Ç
    echo -e "   üî® –°–æ–±–∏—Ä–∞–µ–º –∫–ª–∏–µ–Ω—Ç..."
    cd /home/node/ruplatform/client
    npm run build

    if [ $? -eq 0 ]; then
        echo -e "   ${GREEN}‚úÖ Frontend –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ${NC}"
    else
        echo -e "   ${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ frontend${NC}"
        return 1
    fi

    echo -e "   ${GREEN}‚úÖ –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"
    return 0
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ —Ñ–∞–π–ª—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
verify_files_integrity() {
    echo -e "${YELLOW}2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤...${NC}"

    local problems=0

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö JS —Ñ–∞–π–ª–∞—Ö
    echo -e "   üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ JS —Ñ–∞–π–ª—ã..."
    find /home/node/ruplatform/client/dist -name "*.js" -exec grep -l "https://soulsynergy.ru/api" {} \; | head -3 | while read file; do
        echo -e "      ${YELLOW}–ü—Ä–æ–≤–µ—Ä—è–µ–º: $file${NC}"
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω
        if node -c "$file" 2>/dev/null; then
            echo -e "         ${GREEN}‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω${NC}"
        else
            echo -e "         ${RED}‚ùå –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω${NC}"
            problems=$((problems + 1))
        fi
    done

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
    echo -e "   üîç –ò—â–µ–º –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏..."
    local broken_lines=$(find /home/node/ruplatform/client/dist -name "*.js" -exec grep -l "https://" {} \; | xargs grep -n "https://" | grep -E "https://[^/]*https://" | wc -l)
    if [ "$broken_lines" -gt 0 ]; then
        echo -e "   ${RED}‚ùå –ù–∞–π–¥–µ–Ω–æ $broken_lines –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫${NC}"
        problems=$((problems + 1))
    else
        echo -e "   ${GREEN}‚úÖ –ù–µ—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫${NC}"
    fi

    if [ "$problems" -eq 0 ]; then
        echo -e "   ${GREEN}‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã —Ü–µ–ª—ã${NC}"
        return 0
    else
        echo -e "   ${RED}‚ùå –ù–∞–π–¥–µ–Ω–æ $problems –ø—Ä–æ–±–ª–µ–º${NC}"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è API URL
safe_fix_api_config() {
    echo -e "${BLUE}3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º API –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é...${NC}"

    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è, –ù–ï —Ç—Ä–æ–≥–∞–µ–º JS —Ñ–∞–π–ª—ã
    echo -e "   üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π VITE_API_URL..."
    echo "VITE_API_URL=https://soulsynergy.ru/api" > /home/node/ruplatform/client/.env.production

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ .env.production –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
    if grep -q "https://soulsynergy.ru/api" /home/node/ruplatform/client/.env.production; then
        echo -e "   ${GREEN}‚úÖ VITE_API_URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ${NC}"
    else
        echo -e "   ${RED}‚ùå VITE_API_URL –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô${NC}"
        return 1
    fi

    # –ù–ï —Ç—Ä–æ–≥–∞–µ–º —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ JS —Ñ–∞–π–ª—ã - –ø—É—Å—Ç—å –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏
    # —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º baseURL –∏–∑ axios

    echo -e "   ${GREEN}‚úÖ API –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ${NC}"
    return 0
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
start_application() {
    echo -e "${YELLOW}4. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...${NC}"

    # –ó–∞–ø—É—Å–∫–∞–µ–º PM2
    pm2 start all 2>/dev/null || echo "   PM2 –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è"

    # –ó–∞–ø—É—Å–∫–∞–µ–º nginx
    sudo systemctl start nginx

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å
    if pgrep -f "pm2" > /dev/null; then
        echo -e "   ${GREEN}‚úÖ PM2 –∑–∞–ø—É—â–µ–Ω${NC}"
    else
        echo -e "   ${RED}‚ùå PM2 –Ω–µ –∑–∞–ø—É—â–µ–Ω${NC}"
        return 1
    fi

    if pgrep -f "nginx" > /dev/null; then
        echo -e "   ${GREEN}‚úÖ nginx –∑–∞–ø—É—â–µ–Ω${NC}"
    else
        echo -e "   ${RED}‚ùå nginx –Ω–µ –∑–∞–ø—É—â–µ–Ω${NC}"
        return 1
    fi

    return 0
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
echo -e "${GREEN}üöÄ –ù–ê–ß–ò–ù–ê–ï–ú –ë–ï–ó–û–ü–ê–°–ù–û–ï –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï${NC}"
echo ""

# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
if restore_original_files; then
    echo ""
    echo -e "${BLUE}‚úÖ –ü–ï–†–ï–°–û–ë–û–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê${NC}"
else
    echo ""
    echo -e "${RED}‚ùå –ü–ï–†–ï–°–û–ë–û–†–ö–ê –ù–ï –£–î–ê–õ–ê–°–¨${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å
if verify_files_integrity; then
    echo ""
    echo -e "${BLUE}‚úÖ –¶–ï–õ–û–°–¢–ù–û–°–¢–¨ –§–ê–ô–õ–û–í –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê${NC}"
else
    echo ""
    echo -e "${RED}‚ùå –ü–†–û–ë–õ–ï–ú–´ –° –¶–ï–õ–û–°–¢–ù–û–°–¢–¨–Æ –§–ê–ô–õ–û–í${NC}"
    echo -e "   ${YELLOW}üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å frontend –µ—â–µ —Ä–∞–∑${NC}"
fi

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º API
if safe_fix_api_config; then
    echo ""
    echo -e "${BLUE}‚úÖ API –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ù–ê–°–¢–†–û–ï–ù–ê${NC}"
else
    echo ""
    echo -e "${RED}‚ùå –ü–†–û–ë–õ–ï–ú–ê –° API –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ï–ô${NC}"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
if start_application; then
    echo ""
    echo -e "${GREEN}üéâ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û!${NC}"
    echo ""
    echo -e "${YELLOW}üîÑ –¢–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:${NC}"
    echo "   1. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ: Ctrl+Shift+R"
    echo ""
    echo -e "${YELLOW}üß™ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:${NC}"
    echo "   - –ù–µ—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ JavaScript"
    echo "   - API –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –ø–æ HTTPS"
    echo "   - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç"
    echo "   - –ù–µ—Ç –æ—à–∏–±–æ–∫ Mixed Content"
else
    echo ""
    echo -e "${RED}‚ùå –ù–ï –£–î–ê–õ–û–°–¨ –ó–ê–ü–£–°–¢–ò–¢–¨ –ü–†–ò–õ–û–ñ–ï–ù–ò–ï${NC}"
    echo -e "   ${YELLOW}üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:${NC}"
    echo "   pm2 logs"
    echo "   sudo tail -f /var/log/nginx/error.log"
fi

echo ""
echo -e "${GREEN}üîß –ë–ï–ó–û–ü–ê–°–ù–û–ï –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û${NC}"
