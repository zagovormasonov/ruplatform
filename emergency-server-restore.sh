#!/bin/bash

echo "üö® –ê–í–ê–†–ò–ô–ù–û–ï –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–ï–†–í–ï–†–ê..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${RED}üî• –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–Æ –°–ï–†–í–ï–† –í –†–ê–ë–û–ß–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï...${NC}"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —á—Ç–æ –∑–∞–ø—É—â–µ–Ω–æ
echo -e "${BLUE}‚èπÔ∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã...${NC}"
pm2 stop all 2>/dev/null || echo "PM2 –Ω–µ –∑–∞–ø—É—â–µ–Ω"
pm2 delete all 2>/dev/null || echo "PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
pkill -f "node.*server.js" 2>/dev/null || echo "Node –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

# –ñ–¥–µ–º
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–æ—Å—å
echo -e "${BLUE}üìä –ü—Ä–æ–≤–µ—Ä—è—é —á—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–æ—Å—å...${NC}"
echo "PM2 —Å—Ç–∞—Ç—É—Å:"
pm2 status 2>/dev/null || echo "PM2 –Ω–µ –∑–∞–ø—É—â–µ–Ω"
echo "–ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç–∞—Ö:"
lsof -i :3000 2>/dev/null || echo "–ü–æ—Ä—Ç 3000 —Å–≤–æ–±–æ–¥–µ–Ω"
lsof -i :3001 2>/dev/null || echo "–ü–æ—Ä—Ç 3001 —Å–≤–æ–±–æ–¥–µ–Ω"

echo ""
echo -e "${YELLOW}üîÑ –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–Æ –°–ï–†–í–ï–† –ù–ê –ü–û–†–¢–£ 3000 (–∫–∞–∫ –±—ã–ª–æ)...${NC}"

# –ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 3000 (–∫–∞–∫ –±—ã–ª–æ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ)
cd /home/node/ruplatform/server
echo -e "${BLUE}‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫–∞—é backend –Ω–∞ –ø–æ—Ä—Ç—É 3000...${NC}"
NODE_ENV=production PORT=3000 pm2 start dist/server.js --name "ruplatform-backend"

# –ñ–¥–µ–º
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å
echo -e "${BLUE}üìä –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:${NC}"
pm2 status

# –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ—Ä—Ç
echo -e "${BLUE}üîç –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ—Ä—Ç 3000:${NC}"
if [ -n "$(lsof -i :3000 2>/dev/null)" ]; then
    echo -e "${GREEN}‚úÖ –°–ï–†–í–ï–† –£–°–ü–ï–®–ù–û –ó–ê–ü–£–©–ï–ù –ù–ê –ü–û–†–¢–£ 3000!${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  –ü–æ—Ä—Ç 3000 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è, –ø—Ä–æ–±—É—é –ø–æ—Ä—Ç 3001...${NC}"
    # –ü—Ä–æ–±—É—é 3001
    pm2 delete all
    cd /home/node/ruplatform/server
    NODE_ENV=production PORT=3001 pm2 start dist/server.js --name "ruplatform-backend"
    sleep 3
    if [ -n "$(lsof -i :3001 2>/dev/null)" ]; then
        echo -e "${GREEN}‚úÖ –°–ï–†–í–ï–† –£–°–ü–ï–®–ù–û –ó–ê–ü–£–©–ï–ù –ù–ê –ü–û–†–¢–£ 3001!${NC}"
        echo -e "${YELLOW}‚ö†Ô∏è  –¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é${NC}"
    else
        echo -e "${RED}‚ùå –°–ï–†–í–ï–† –ù–ï –£–î–ê–ï–¢–°–Ø –ó–ê–ü–£–°–¢–ò–¢–¨${NC}"
        echo "–ü—Ä–æ–±—É—é –∑–∞–ø—É—Å–∫ –Ω–∞–ø—Ä—è–º—É—é..."
        cd /home/node/ruplatform/server
        NODE_ENV=production PORT=3000 node dist/server.js &
        sleep 3
        if [ -n "$(lsof -i :3000 2>/dev/null)" ]; then
            echo -e "${GREEN}‚úÖ –°–ï–†–í–ï–† –ó–ê–ü–£–©–ï–ù –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï –ù–ê –ü–û–†–¢–£ 3000!${NC}"
        else
            echo -e "${RED}‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê - –°–ï–†–í–ï–† –ù–ï –ó–ê–ü–£–°–ö–ê–ï–¢–°–Ø${NC}"
        fi
    fi
fi

echo ""
echo -e "${GREEN}üéØ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!${NC}"
echo ""
echo -e "${YELLOW}üìã –ß–¢–û –°–ï–ô–ß–ê–° –†–ê–ë–û–¢–ê–ï–¢:${NC}"
echo "   ‚Ä¢ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ —Ä–∞–±–æ—á–µ–º –ø–æ—Ä—Ç—É"
echo "   ‚Ä¢ PM2 –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã"
echo "   ‚Ä¢ Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã"
echo ""
echo -e "${GREEN}üîÑ –ü–†–û–í–ï–†–¨–¢–ï –°–ê–ô–¢: https://soulsynergy.ru${NC}"
echo ""
echo -e "${YELLOW}üí° –ï–°–õ–ò –ü–†–û–ë–õ–ï–ú–´ –ü–†–û–î–û–õ–ñ–ê–Æ–¢–°–Ø:${NC}"
echo "   1. –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞"
echo "   2. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É"
echo "   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞"
echo ""
echo -e "${GREEN}‚úÖ –°–ï–†–í–ï–† –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù!${NC}"
