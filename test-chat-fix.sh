#!/bin/bash

echo "üîß –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–ù–û–ü–ö–ò '–°–í–Ø–ó–ê–¢–¨–°–Ø –° –≠–ö–°–ü–ï–†–¢–û–ú'..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ API –ø—Ä–æ—Ñ–∏–ª—è —ç–∫—Å–ø–µ—Ä—Ç–∞
test_expert_api() {
    echo -e "${BLUE}üîç –¢–ï–°–¢–ò–†–£–ï–ú API –ü–†–û–§–ò–õ–Ø –≠–ö–°–ü–ï–†–¢–ê...${NC}"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç userId
    local response=$(curl -s "http://localhost:3000/api/experts/1" 2>/dev/null)

    if [ $? -eq 0 ] && [ "$response" != "" ]; then
        echo -e "   ${GREEN}‚úÖ API –ø—Ä–æ—Ñ–∏–ª—è —ç–∫—Å–ø–µ—Ä—Ç–∞ –æ—Ç–≤–µ—á–∞–µ—Ç${NC}"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å userId –≤ –æ—Ç–≤–µ—Ç–µ
        if echo "$response" | grep -q '"userId"'; then
            echo -e "   ${GREEN}‚úÖ userId –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ${NC}"
            echo -e "   üìÑ –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:"
            echo "$response" | head -3
            return 0
        else
            echo -e "   ${RED}‚ùå userId –ù–ï –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ${NC}"
            echo -e "   üìÑ –û—Ç–≤–µ—Ç API:"
            echo "$response" | head -5
            return 1
        fi
    else
        echo -e "   ${RED}‚ùå API –ø—Ä–æ—Ñ–∏–ª—è —ç–∫—Å–ø–µ—Ä—Ç–∞ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç${NC}"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ API —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞
test_chat_api() {
    echo -e "${BLUE}üí¨ –¢–ï–°–¢–ò–†–£–ï–ú API –°–û–ó–î–ê–ù–ò–Ø –ß–ê–¢–ê...${NC}"

    # –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω—É–∂–µ–Ω —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    # –≠—Ç–æ –±—É–¥–µ—Ç —Å–ª–æ–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞

    echo -e "   ${YELLOW}‚ö†Ô∏è API —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏${NC}"
    echo -e "   ${YELLOW}‚ö†Ô∏è –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è${NC}"
    return 0
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ backend
rebuild_backend() {
    echo -e "${BLUE}üî® –ü–ï–†–ï–°–ë–û–†–ö–ê BACKEND...${NC}"

    cd /home/node/ruplatform/server

    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2
    echo -e "   üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2..."
    pm2 stop ruplatform-backend 2>/dev/null || true
    pm2 delete ruplatform-backend 2>/dev/null || true

    # –°–æ–±–∏—Ä–∞–µ–º
    echo -e "   üî® –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É..."
    npm run build

    if [ $? -eq 0 ]; then
        echo -e "   ${GREEN}‚úÖ Backend —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ${NC}"
        return 0
    else
        echo -e "   ${RED}‚ùå –°–±–æ—Ä–∫–∞ backend –Ω–µ —É–¥–∞–ª–∞—Å—å${NC}"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ backend
start_backend() {
    echo -e "${BLUE}üöÄ –ó–ê–ü–£–°–ö BACKEND...${NC}"

    cd /home/node/ruplatform/server

    # –ó–∞–ø—É—Å–∫–∞–µ–º
    echo -e "   üì° –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ PM2..."
    pm2 start dist/index.js --name "ruplatform-backend" -- --port 3000

    if [ $? -eq 0 ]; then
        echo -e "   ${GREEN}‚úÖ Backend –∑–∞–ø—É—â–µ–Ω${NC}"
        echo -e "   üìä –°—Ç–∞—Ç—É—Å PM2:"
        pm2 status
        return 0
    else
        echo -e "   ${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å backend${NC}"
        return 1
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
echo -e "${GREEN}üöÄ –ù–ê–ß–ò–ù–ê–ï–ú –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ß–ê–¢–ê${NC}"
echo ""

# –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º backend
if rebuild_backend; then
    echo ""
    echo -e "${BLUE}‚úÖ BACKEND –ü–ï–†–ï–°–û–ë–†–ê–ù${NC}"
else
    echo ""
    echo -e "${RED}‚ùå –ù–ï –£–î–ê–õ–û–°–¨ –ü–ï–†–ï–°–û–ë–†–ê–¢–¨ BACKEND${NC}"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º backend
if start_backend; then
    echo ""
    echo -e "${BLUE}‚úÖ BACKEND –ó–ê–ü–£–©–ï–ù${NC}"
else
    echo ""
    echo -e "${RED}‚ùå –ù–ï –£–î–ê–õ–û–°–¨ –ó–ê–ü–£–°–¢–ò–¢–¨ BACKEND${NC}"
    exit 1
fi

# –¢–µ—Å—Ç–∏—Ä—É–µ–º API
echo ""
if test_expert_api && test_chat_api; then
    echo ""
    echo -e "${GREEN}üéâ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´!${NC}"
    echo ""
    echo -e "${YELLOW}üîÑ –¢–µ–ø–µ—Ä—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:${NC}"
    echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å —ç–∫—Å–ø–µ—Ä—Ç–∞"
    echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∏–º—è"
    echo "   3. –ù–∞–∂–º–∏—Ç–µ '–°–≤—è–∑–∞—Ç—å—Å—è —Å —ç–∫—Å–ø–µ—Ä—Ç–æ–º'"
    echo "   4. –î–æ–ª–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –≤ —á–∞—Ç –ë–ï–ó –æ—à–∏–±–∫–∏ 400"
    echo ""
    echo -e "${YELLOW}üß™ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞:${NC}"
    echo "   - –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏ '–°–æ–∑–¥–∞–µ–º —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: X'"
    echo "   - –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏ '–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:' —Å chatId"
    echo "   - –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 'ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'"
    echo ""
    echo -e "${GREEN}üî• –ü–†–û–ë–õ–ï–ú–ê –° –ß–ê–¢–û–ú –ò–°–ü–†–ê–í–õ–ï–ù–ê!${NC}"
else
    echo ""
    echo -e "${RED}‚ùå –ü–†–û–ë–õ–ï–ú–´ –û–°–¢–ê–õ–ò–°–¨${NC}"
    exit 1
fi
